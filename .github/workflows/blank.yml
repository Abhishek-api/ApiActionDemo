name: Kong Deployment on Apiops with dev-portal
on:
  push:
    branches:
      - main
#ffd
jobs:
  OAS_To_KONG:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2
      

    - name: Install Insomnia CLI
      run: |
        wget https://github.com/Kong/insomnia/releases/download/lib%403.12.0/inso-linux-3.12.0.tar.xz
        tar -xf inso-linux-3.12.0.tar.xz

    - name: Lint OpenAPI Spec
      run: ./inso lint spec pipe1.yml
    
    - name: Generate kong.yaml
      run: ./inso generate config pipe1.yml --type declarative -o kong.yaml
    
    - name: open kong.yaml
      run: cat /home/runner/work/ApiActionDemo/ApiActionDemo/kong.yaml
    
    - name: install deck CLI
      run: |
        curl -sL https://github.com/kong/deck/releases/download/v1.17.2/deck_1.17.2_linux_amd64.tar.gz -o deck.tar.gz
        tar -xf deck.tar.gz -C /tmp 
        sudo cp /tmp/deck /usr/local/bin/
    
    - name: check
      run: deck validate -s /home/runner/work/ApiActionDemo/ApiActionDemo/kong.yaml
    
    - name: Convert kong declartive
      run: |
          deck convert --from kong-gateway-2.x --to kong-gateway-3.x --input-file kong.yaml --output-file new-kong.yaml

    - name: Deploy to Kong
      run: deck sync -s new-kong.yaml --kong-addr http://34.125.240.32:8001 --tls-skip-verify
 
  publish-cutomer-api-to-portal:
    name: Publish OAS to dev portal
    needs: OAS_To_KONG
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
      - uses: actions/checkout@v2
      - name: Install NodeJs
      - uses: actions/setup-node@v3
      - name: Install kon-dev-portal-cli
      - run: npm install -g kong-portal-cli


      - name: Deploy to dev portal
      - run: |
           portal deploy -D  --preserve defualt
      - env :
         KONG_ADMIN_URL: ${{ secrets.KONG_ADMIN_ADDR }}
     

